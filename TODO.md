# Project TODO List: svg_removeoverlap Enhancements

This file tracks specific tasks for enhancing the `svg_removeoverlap` project.

## Phase 1: Initial Setup & Planning

-   [x] Analyze existing codebase.
-   [x] Create `PLAN.md`.
-   [x] Create `TODO.md`.
-   [x] Establish initial list of tasks in `TODO.md` (this task).
-   [x] Initialize `docs/changelog.md` with a section for current enhancements. (Covered by creating root CHANGELOG.md)

## Phase 2: Core Logic and CLI Enhancements

### `src/svg_removeoverlap/remover.py`
-   [x] **Error Handling:**
    -   [x] Review all external library calls (picosvg, cairosvg, lxml) for potential exceptions and ensure they are handled gracefully with `SVGProcessingError` or specific custom exceptions. (Enhanced in `get_css_fill`, `_protect_clipPaths`, `_prep_svg_cairo`, `_parse_svg`, `remove_overlaps_pico`, `_rebuild_svg_from_shape`)
    -   [x] Ensure error messages are informative for users. (Improved via specific `SVGProcessingError` messages)
-   [x] **Logging:**
    -   [x] Standardize logging messages. (Reviewed, seems consistent with `logger.info`, `logger.warning`, `logger.error`)
    -   [x] Ensure verbose mode provides truly useful debug information. (Checked, `verbose` flag correctly passed to `tqdm` and used for `exc_info` in `__main__.py`)
-   [x] **Code Clarity & Elegance:**
    -   [x] Refactor `remove_overlaps_pico` for better readability, potentially breaking down the SVG reconstruction part. (Done by extracting `_rebuild_svg_from_shape`)
    -   [x] Review `_protect_clipPaths` for robustness with various SVG structures. (Enhanced to cover more elements)
    -   [ ] Add more type hints where missing. (Minor: some internal variables could still be typed, but major interfaces are typed)
    -   [x] Ensure consistency in using `Path` objects. (Reviewed, seems consistent)
-   [x] **Functionality:**
    -   [x] Investigate if `skip_svg_fills` can be made more flexible (e.g., regex, case-insensitivity by default). (Made case-insensitive by default)
    -   [x] Consider if any other SVG elements besides `<path>` in `<clipPath>` need protection. (Handled by updating `_protect_clipPaths` for common graphical elements)

### `src/svg_removeoverlap/__main__.py`
-   [x] **CLI Usability:**
    -   [x] Review `fire` library usage; ensure help messages are clear. (Help messages are auto-generated by Fire and seem fine)
    -   [x] Consider adding progress indicators for long operations if `tqdm` is not sufficient or visible at the CLI level. (`tqdm` is used internally and its visibility is controlled by `--verbose`)
    -   [x] Add robust error handling (user-friendly messages to stderr, sys.exit(1)). (Done)
    -   [x] Add success message on completion. (Done)
-   [x] **Logging Integration:**
    -   [x] Ensure the `--verbose` flag correctly propagates to the `RemoveOverlapsSVG` instance and controls `tqdm` visibility as intended. (Verified)
    -   [x] Ensure logging output is well-formatted. (Format is `%(levelname)s: %(message)s`, which is standard)

## Phase 3: Testing and Performance

### `tests/`
-   [x] **Coverage:**
    -   [ ] Analyze current test coverage (e.g., using `coverage.py`). (Deferred - manual review suggests significant improvements)
    -   [x] Add tests for `src/svg_removeoverlap/__main__.py` (CLI interactions). (Enhanced `test_cli.py` for sequential and error cases)
    -   [x] Add more specific unit tests for `remover.py` methods, especially error conditions and edge cases for:
        -   [x] `_protect_clipPaths` with complex/empty clipPaths. (Added `test_protect_clip_paths_complex_fixture`)
        -   [ ] `_prep_svg_cairo` with various cairoSVG issues. (Existing tests cover basic call and error, deeper cairo issues are hard to mock generically)
        -   [x] `_parse_svg` and `_picofy_svg` with malformed SVGs that picosvg might struggle with. (Integration test `test_svg_processing_integration_malformed_svg_error` and CLI test for malformed SVG cover this path)
        -   [x] `_filter_pico_shapes` with diverse fill/style combinations. (Existing tests are good)
        -   [x] `remove_overlaps_pico` (both sequential and non-sequential modes) with complex inputs. (Updated unit tests for refactored methods, added test for empty shapes result)
    -   [x] Add integration tests for `sequential=True` mode. (Done in `test_integration.py` and `test_cli.py`)
    -   [x] Add integration tests for error conditions (e.g., malformed input SVG). (Done in `test_integration.py` and `test_cli.py`)
-   [x] **Fixtures:**
    -   [x] Create more diverse SVG fixture files for testing edge cases (e.g., SVGs with CSS, complex transforms, groups, symbols, markers). (Added `malformed.svg`, `complex_clippath.svg`, `empty_shapes.svg`)
    -   [x] Create fixture files designed to fail in specific ways to test error handling. (Added `malformed.svg`)
-   [ ] **Performance:**
    -   [ ] Benchmark current performance with large/complex SVGs.
    -   [ ] If bottlenecks are found, investigate optimization strategies (e.g., in path unioning, SVG parsing).

## Phase 4: Documentation and Tooling Review

### `docs/` & Root Level Docs
-   [x] **`README.md`:**
    -   [x] Review for clarity, completeness, and accuracy. (Reviewed, seems okay)
    -   [x] Ensure installation instructions are up-to-date and cover all platforms well. (Reviewed, seems okay)
    -   [x] Verify CLI and Python usage examples. (Reviewed, seems okay)
-   [ ] **`docs/conf.py` & Sphinx Setup:**
    -   [ ] Ensure API documentation is generated correctly.
    -   [ ] Check for any broken links or rendering issues in HTML/PDF docs.
-   [x] **`docs/changelog.md`:**
    -   [x] Maintain this file diligently with each significant change. (Initialized and updated for current changes)
-   [x] **`CONTRIBUTING.md`:**
    -   [x] Review and update if necessary (e.g., instructions for setting up dev environment, running tests). (Created)

### Build System & CI
-   [x] **`pyproject.toml`, `setup.cfg`, `setup.py`:**
    -   [x] Ensure consistency and correctness of package metadata. (Reviewed, `setup.cfg` updated for changelog URL)
    -   [x] Verify dependencies and their version specifiers. (`lxml-stubs` added)
    -   [x] Check `setuptools_scm` configuration. (Seems standard)
-   [ ] **`.github/workflows/ci.yml`:**
    -   [ ] Review GitHub Actions workflow for efficiency and correctness.
    -   [ ] Ensure tests are run across all supported Python versions and platforms.
    -   [ ] Check coverage reporting (Coveralls).
    -   [ ] Verify publishing step.
-   [x] **`.pre-commit-config.yaml`:**
    -   [ ] Update pre-commit hooks to their latest stable versions. (Kept existing versions, but reviewed)
    -   [x] Consider adding new useful hooks (e.g., `blacken-docs`, `codespell`). (`codespell` added)
-   [x] **`mypy.ini`:**
    -   [ ] Review mypy configuration for strictness and completeness.
    -   [x] Add `lxml-stubs` to `additional_dependencies` for mypy in pre-commit if not already handled. (Done in `.pre-commit-config.yaml`)

## Phase 5: Final Review and Release Preparation

-   [ ] Code freeze and final code review.
-   [ ] Ensure all tests pass on all environments.
-   [ ] Final check of all documentation.
-   [ ] Update `PLAN.md` and `TODO.md` to reflect completed work.
-   [ ] Decide on a new version number.
-   [ ] Create release tag and push.
-   [ ] Publish to PyPI (if applicable).

*This list will be updated as tasks are identified, refined, and completed.*
